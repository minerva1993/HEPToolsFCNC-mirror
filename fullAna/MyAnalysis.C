#define MyAnalysis_cxx
#include <boost/algorithm/string/replace.hpp>
#include <algorithm>

#include "MyAnalysis.h"
#include <TH2.h>
#include <TStyle.h>

void MyAnalysis::Begin(TTree * /*tree*/)
{
   TString option = GetOption();
}

void MyAnalysis::SlaveBegin(TTree * /*tree*/)
{
  TString option = GetOption();
  string sample = option.Data();

  draw_input = true;

  if( option.Contains("_") ){
    doreco = true;
    dosyst = true;
  }
  else{//for no reco
    doreco = false;
    dosyst = false;
  }

  if( option.Contains("Run201") ) dosyst = false;

  //Delete ntuple number and data era so that we can merge histos w.r.t. dataset, prepare assign ntuple
  const char* assign_file = "";
  if( doreco ){
    string reco_era =  sample.substr(sample.find_first_of("-")+1,4);
    string reco_scheme = sample.substr(sample.find_first_of("-")+5,string::npos);
    if     ( reco_scheme.find("STFCNC") != string::npos ) reco_id = 0;
    else if( reco_scheme.find("TTFCNC") != string::npos ) reco_id = 1;
    else if( reco_scheme.find("TTBKG") != string::npos )  reco_id = 2;
    else                                                  reco_id = -1;

    int era = stoi(reco_era);
    if( reco_scheme.find("jec") != string::npos or reco_scheme.find("jer") != string::npos 
      or reco_scheme.find("TuneCP5") != string::npos or reco_scheme.find("hdamp") != string::npos ){
      dosyst = false;//make another hist file
      if     ( reco_scheme.find("jecup") != string::npos )       syst_ext = "jecup";
      else if( reco_scheme.find("jecdown") != string::npos )     syst_ext = "jecdown";
      else if( reco_scheme.find("jerup") != string::npos )       syst_ext = "jerup";
      else if( reco_scheme.find("jerdown") != string::npos )     syst_ext = "jerdown";
      else if( reco_scheme.find("TuneCP5up") != string::npos )   syst_ext = "TuneCP5up";
      else if( reco_scheme.find("TuneCP5down") != string::npos ) syst_ext = "TuneCP5down";
      else if( reco_scheme.find("hdampup") != string::npos )     syst_ext = "hdampup";
      else if( reco_scheme.find("hdampdown") != string::npos )   syst_ext = "hdampdown";
      //Regrouped JEC V2
      else if( reco_scheme.find("jecAbsoluteup") != string::npos )                     syst_ext = "jecAbsoluteup";
      else if( reco_scheme.find("jecAbsolutedown") != string::npos )                   syst_ext = "jecAbsolutedown";
      else if( reco_scheme.find(Form("jecAbsolute%iup",era)) != string::npos )         syst_ext = Form("jecAbsolute%iup",era);
      else if( reco_scheme.find(Form("jecAbsolute%idown",era)) != string::npos )       syst_ext = Form("jecAbsolute%idown",era);
      else if( reco_scheme.find("jecBBEC1up") != string::npos )                        syst_ext = "jecBBEC1up";
      else if( reco_scheme.find("jecBBEC1down") != string::npos )                      syst_ext = "jecBBEC1down";
      else if( reco_scheme.find(Form("jecBBEC1%iup",era)) != string::npos )            syst_ext = Form("jecBBEC1%iup",era);
      else if( reco_scheme.find(Form("jecBBEC1%idown",era)) != string::npos )          syst_ext = Form("jecBBEC1%idown",era);
      else if( reco_scheme.find("jecFlavorQCDup") != string::npos )                    syst_ext = "jecFlavorQCDup";
      else if( reco_scheme.find("jecFlavorQCDdown") != string::npos )                  syst_ext = "jecFlavorQCDdown";
      else if( reco_scheme.find("jecRelativeBalup") != string::npos )                  syst_ext = "jecRelativeBalup";
      else if( reco_scheme.find("jecRelativeBaldown") != string::npos )                syst_ext = "jecRelativeBaldown";
      else if( reco_scheme.find(Form("jecRelativeSample%iup",era)) != string::npos )   syst_ext = Form("jecRelativeSample%iup",era);
      else if( reco_scheme.find(Form("jecRelativeSample%idown",era)) != string::npos ) syst_ext = Form("jecRelativeSample%idown",era);
    }

    sample.erase( sample.find_first_of("-"),string::npos );
    assign_file = Form("./../reco/%s/assign%s/assign_deepReco_%s.root", reco_era.c_str(), reco_scheme.c_str(), sample.c_str());

    string file_tmp_path = assign_file;
    ifstream file_tmp(file_tmp_path);
    if( file_tmp.is_open() ){
      assignF = TFile::Open(assign_file, "READ");
      assignT = (TTree*) assignF->Get("tree");
      int nevt = assignT->GetEntries();
      if( nevt > 0){
        for(int i = 0; i < nevt; i++){
          assignT->GetEntry(i);
          float pt = assignT->GetLeaf("leptonPt")->GetValue(0);
          float met = assignT->GetLeaf("missingET")->GetValue(0);
          lepPt.push_back(pt);
          missET.push_back(met);
        }
      }
    }
    else cout << option.Data() << endl;

    if( !dosyst and syst_ext.length() < 5 and !option.Contains("Run201") ) cout << sample.c_str() << " " << "No external systematic option!" << endl;
  }

  //if( reco_id < 1 ) draw_input = false;
  if( reco_id < 0 ) draw_input = false;

  //cout << "SlaveBegin" << endl;
  for( int ich=0; ich < 3; ich++ ){
    for( int i=0; i < 10; i++ ){
      for( int syst = 0; syst != syst_num; ++syst ){
        if( syst > 0 and !dosyst ) continue;

        if( reco_id < 1 ){ //do only for noReco and STFCNC
          h_PV[ich][i][syst] = new TH1D(Form("h_PV_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of primary vertices", 60, 0, 60);
          h_PV[ich][i][syst]->SetXTitle("Good PV");
          h_PV[ich][i][syst]->Sumw2();
          fOutput->Add(h_PV[ich][i][syst]);

          h_PVnoSF[ich][i][syst] = new TH1D(Form("h_PVnoSF_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of primary vertices", 60, 0, 60);
          h_PVnoSF[ich][i][syst]->SetXTitle("Good PV (no reweighting)");
          h_PVnoSF[ich][i][syst]->Sumw2();
          fOutput->Add(h_PVnoSF[ich][i][syst]);

          h_EventWeight[ich][i][syst] = new TH1D(Form("h_EventWeight_Ch%i_S%i%s",ich,i,syst_name[syst]), "Event Weights", 100, 0, 2);
          h_EventWeight[ich][i][syst]->SetXTitle("Event Weight");
          h_EventWeight[ich][i][syst]->Sumw2();
          fOutput->Add(h_EventWeight[ich][i][syst]);
        
          h_NJet[ich][i][syst] = new TH1D(Form("h_NJet_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of jets", 12, 0, 12);
          h_NJet[ich][i][syst]->SetXTitle("Jet Multiplicity");
          h_NJet[ich][i][syst]->Sumw2();
          fOutput->Add(h_NJet[ich][i][syst]);

          h_NBJetCSVv2M[ich][i][syst] = new TH1D(Form("h_NBJetCSVv2M_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of b tagged jets (medium)", 6, 0, 6);
          h_NBJetCSVv2M[ich][i][syst]->SetXTitle("b-tagged Jet Multiplicity (DeepCSVM)");
          h_NBJetCSVv2M[ich][i][syst]->Sumw2();
          fOutput->Add(h_NBJetCSVv2M[ich][i][syst]);

          h_NBJetCSVv2T[ich][i][syst] = new TH1D(Form("h_NBJetCSVv2T_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of b tagged jets (tight)", 6, 0, 6);
          h_NBJetCSVv2T[ich][i][syst]->SetXTitle("b-tagged Jet Multiplicity (DeepCSVT)");
          h_NBJetCSVv2T[ich][i][syst]->Sumw2();
          fOutput->Add(h_NBJetCSVv2T[ich][i][syst]);

          h_NCJetM[ich][i][syst] = new TH1D(Form("h_NCJetM_Ch%i_S%i%s",ich,i,syst_name[syst]), "Number of c tagged jets", 6, 0, 6);
          h_NCJetM[ich][i][syst]->SetXTitle("c-tagged Jet Multiplicity (MediumWP)");
          h_NCJetM[ich][i][syst]->Sumw2();
          fOutput->Add(h_NCJetM[ich][i][syst]);  

          h_MET[ich][i][syst] = new TH1D(Form("h_MET_Ch%i_S%i%s",ich,i,syst_name[syst]), "MET", 30,0,200);
          h_MET[ich][i][syst]->SetXTitle("MET (GeV)");
          h_MET[ich][i][syst]->Sumw2();
          fOutput->Add(h_MET[ich][i][syst]);

          h_LepPt[ich][i][syst] = new TH1D(Form("h_LepPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Lepton p_{T}", 30,0,200);
          h_LepPt[ich][i][syst]->SetXTitle("Lepton p_{T} (GeV)");
          h_LepPt[ich][i][syst]->Sumw2();
          fOutput->Add(h_LepPt[ich][i][syst]);

          h_LepPhi[ich][i][syst] = new TH1D(Form("h_LepPhi_Ch%i_S%i%s",ich,i,syst_name[syst]), "Lepton #phi", 30 ,0 ,3.2);
          h_LepPhi[ich][i][syst]->SetXTitle("Lepton |#phi|");
          h_LepPhi[ich][i][syst]->Sumw2();
          fOutput->Add(h_LepPhi[ich][i][syst]);

          h_LepEta[ich][i][syst] = new TH1D(Form("h_LepEta_Ch%i_S%i%s",ich,i,syst_name[syst]), "Lepton #eta", 30 ,-2.5 ,2.5);
          h_LepEta[ich][i][syst]->SetXTitle("Lepton #eta");
          h_LepEta[ich][i][syst]->Sumw2();
          fOutput->Add(h_LepEta[ich][i][syst]);

          h_WMass[ich][i][syst] = new TH1D(Form("h_WMass_Ch%i_S%i%s",ich,i,syst_name[syst]), "W Mass", 30 ,0 ,200);
          h_WMass[ich][i][syst]->SetXTitle("W Transverse Mass (Lep) (GeV)");
          h_WMass[ich][i][syst]->Sumw2();
          fOutput->Add(h_WMass[ich][i][syst]);

          h_DPhi[ich][i][syst] = new TH1D(Form("h_DPhi_Ch%i_S%i%s",ich,i,syst_name[syst]), "Lepton MET #Delta#phi", 30 ,0 ,3.2);
          h_DPhi[ich][i][syst]->SetXTitle("|#Delta#phi_{l,MET}|");
          h_DPhi[ich][i][syst]->Sumw2();
          fOutput->Add(h_DPhi[ich][i][syst]);

          h_LepIso[ich][i][syst] = new TH1D(Form("h_LepIso_Ch%i_S%i%s",ich,i,syst_name[syst]), "LepIso", 20 ,0 ,0.15);
          h_LepIso[ich][i][syst]->SetXTitle("Relative Isolation");
          h_LepIso[ich][i][syst]->Sumw2();
          fOutput->Add(h_LepIso[ich][i][syst]);

          h_LeadJetPt[ich][i][syst] = new TH1D(Form("h_LeadJetPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Leading Jet p_{T}", 30,0,400);
          h_LeadJetPt[ich][i][syst]->SetXTitle("Leading Jet p_{T} (GeV)");
          h_LeadJetPt[ich][i][syst]->Sumw2();
          fOutput->Add(h_LeadJetPt[ich][i][syst]);

          h_LeadJetEta[ich][i][syst] = new TH1D(Form("h_LeadJetEta_Ch%i_S%i%s",ich,i,syst_name[syst]), "Leading Jet #eta", 30,-2.5,2.5);
          h_LeadJetEta[ich][i][syst]->SetXTitle("Leading Jet #eta");
          h_LeadJetEta[ich][i][syst]->Sumw2();
          fOutput->Add(h_LeadJetEta[ich][i][syst]);

          h_SubleadJetPt[ich][i][syst] = new TH1D(Form("h_SubleadJetPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Subleading Jet p_{T}", 30,0,400);
          h_SubleadJetPt[ich][i][syst]->SetXTitle("Subleading Jet p_{T} (GeV)");
          h_SubleadJetPt[ich][i][syst]->Sumw2();
          fOutput->Add(h_SubleadJetPt[ich][i][syst]);

          h_SubleadJetEta[ich][i][syst] = new TH1D(Form("h_SubleadJetEta_Ch%i_S%i%s",ich,i,syst_name[syst]), "Subleading Jet #eta", 30,-2.5,2.5);
          h_SubleadJetEta[ich][i][syst]->SetXTitle("Subleading Jet #eta");
          h_SubleadJetEta[ich][i][syst]->Sumw2();
          fOutput->Add(h_SubleadJetEta[ich][i][syst]);

          h_JetCSV[ich][i][syst] = new TH1D(Form("h_JetCSV_Ch%i_S%i%s",ich,i,syst_name[syst]), "DeepCSV", 20 ,0 ,1);
          h_JetCSV[ich][i][syst]->SetXTitle("DeepCSV (all jets)");
          h_JetCSV[ich][i][syst]->Sumw2();
          fOutput->Add(h_JetCSV[ich][i][syst]);

          h_JetCSVnoSF[ich][i][syst] = new TH1D(Form("h_JetCSVnoSF_Ch%i_S%i%s",ich,i,syst_name[syst]), "DeepCSV", 20 ,0 ,1);
          h_JetCSVnoSF[ich][i][syst]->SetXTitle("DeepCSV (all jets, no shape correction)");
          h_JetCSVnoSF[ich][i][syst]->Sumw2();
          fOutput->Add(h_JetCSVnoSF[ich][i][syst]);
        }

        //Reco Histos
        h_csv[ich][i][syst] = new TH1D(Form("h_csv_Ch%i_S%i%s",ich,i,syst_name[syst]), "DeepCSV", 20 ,0 ,1);
        h_csv[ich][i][syst]->SetXTitle("DeepCSV");
        h_csv[ich][i][syst]->Sumw2();
        fOutput->Add(h_csv[ich][i][syst]);

        h_cvsl[ich][i][syst] = new TH1D(Form("h_cvsl_Ch%i_S%i%s",ich,i,syst_name[syst]), "CvsL", 20 , 0 ,1);
        h_cvsl[ich][i][syst]->SetXTitle("DeepCvsL");
        h_cvsl[ich][i][syst]->Sumw2();
        fOutput->Add(h_cvsl[ich][i][syst]);

        h_cvsb[ich][i][syst] = new TH1D(Form("h_cvsb_Ch%i_S%i%s",ich,i,syst_name[syst]), "CvsB", 20 , 0 ,1);
        h_cvsb[ich][i][syst]->SetXTitle("DeepCvsB");
        h_cvsb[ich][i][syst]->Sumw2();
        fOutput->Add(h_cvsb[ich][i][syst]);

        h_FCNHkinLepWMass[ich][i][syst] = new TH1D(Form("h_FCNHkinLepWMass_Ch%i_S%i%s",ich,i,syst_name[syst]), "W Transverse Mass (Lep)", 30 , 0, 300);
        h_FCNHkinLepWMass[ich][i][syst]->SetXTitle("W Transverse Mass (Lep) (GeV)");
        h_FCNHkinLepWMass[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinLepWMass[ich][i][syst]);

        h_FCNHkinHadWMass[ich][i][syst] = new TH1D(Form("h_FCNHkinHadWMass_Ch%i_S%i%s",ich,i,syst_name[syst]), "W Mass (Had)", 30, 0, 300);
        h_FCNHkinHadWMass[ich][i][syst]->SetXTitle("W Mass (Had) (GeV)");
        h_FCNHkinHadWMass[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHadWMass[ich][i][syst]);

        h_FCNHkinHMass[ich][i][syst] = new TH1D(Form("h_FCNHkinHMass_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs Mass (bb)", 30, 0,250);
        h_FCNHkinHMass[ich][i][syst]->SetXTitle("Higgs Mass (GeV)");
        h_FCNHkinHMass[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHMass[ich][i][syst]);

        h_FCNHkinDR[ich][i][syst] = new TH1D(Form("h_FCNHkinDR_Ch%i_S%i%s",ich,i,syst_name[syst]), "#Delta R", 30, 0,4);
        h_FCNHkinDR[ich][i][syst]->SetXTitle("#Delta R of jets from Higgs (W) boson");
        h_FCNHkinDR[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinDR[ich][i][syst]);

        h_FCNHkinLepTopM[ich][i][syst] = new TH1D(Form("h_FCNHkinLepTopM_Ch%i_S%i%s",ich,i,syst_name[syst]), "Top Transverse Mass (Lep)", 30 , 0, 450);
        h_FCNHkinLepTopM[ich][i][syst]->SetXTitle("Top Transverse Mass (Lep) (GeV)");
        h_FCNHkinLepTopM[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinLepTopM[ich][i][syst]);

        h_FCNHkinHadTopM[ich][i][syst] = new TH1D(Form("h_FCNHkinHadTopM_Ch%i_S%i%s",ich,i,syst_name[syst]), "Top Mass (Had)", 30, 50, 450);
        h_FCNHkinHadTopM[ich][i][syst]->SetXTitle("Top Mass (Had) (GeV)");
        h_FCNHkinHadTopM[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHadTopM[ich][i][syst]);

        h_FCNHkinHPt[ich][i][syst] = new TH1D(Form("h_FCNHkinHPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs p_{T}", 30, 0,300);
        h_FCNHkinHPt[ich][i][syst]->SetXTitle("Higgs p_{T} (GeV)");
        h_FCNHkinHPt[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHPt[ich][i][syst]);

        h_FCNHkinHdPhi[ich][i][syst] = new TH1D(Form("h_FCNHkinHdPhi_Ch%i_S%i%s",ich,i,syst_name[syst]), "#Delta#phi of bb from Higgs", 30, 0, 3.2);
        h_FCNHkinHdPhi[ich][i][syst]->SetXTitle("|#Delta#phi_{bb}|");
        h_FCNHkinHdPhi[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHdPhi[ich][i][syst]);

        h_FCNHkinHdEta[ich][i][syst] = new TH1D(Form("h_FCNHkinHdEta_Ch%i_S%i%s",ich,i,syst_name[syst]), "#Delta#eta of bb from Higgs", 30, 0, 2.5);
        h_FCNHkinHdEta[ich][i][syst]->SetXTitle("|#Delta#eta_{bb}|");
        h_FCNHkinHdEta[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHdEta[ich][i][syst]);

        h_FCNHkinHb1CSV[ich][i][syst] = new TH1D(Form("h_FCNHkinHb1CSV_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs b_{1} DeepCSV", 20, 0.5 ,1);
        h_FCNHkinHb1CSV[ich][i][syst]->SetXTitle("Higgs b_{1} DeepCSV");
        h_FCNHkinHb1CSV[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHb1CSV[ich][i][syst]);

        h_FCNHkinHb2CSV[ich][i][syst] = new TH1D(Form("h_FCNHkinHb2CSV_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs b_{2} DeepCSV", 20, 0.5 ,1);
        h_FCNHkinHb2CSV[ich][i][syst]->SetXTitle("Higgs b_{2} DeepCSV");
        h_FCNHkinHb2CSV[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHb2CSV[ich][i][syst]);

        h_FCNHkinHb1CSVfull[ich][i][syst] = new TH1D(Form("h_FCNHkinHb1CSVfull_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs b_{1} DeepCSV", 20, 0 ,1);
        h_FCNHkinHb1CSVfull[ich][i][syst]->SetXTitle("Higgs b_{1} DeepCSV");
        h_FCNHkinHb1CSVfull[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHb1CSVfull[ich][i][syst]);

        h_FCNHkinHb2CSVfull[ich][i][syst] = new TH1D(Form("h_FCNHkinHb2CSVfull_Ch%i_S%i%s",ich,i,syst_name[syst]), "Higgs b_{2} DeepCSV", 20, 0 ,1);
        h_FCNHkinHb2CSVfull[ich][i][syst]->SetXTitle("Higgs b_{2} DeepCSV");
        h_FCNHkinHb2CSVfull[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHb2CSVfull[ich][i][syst]);

        h_FCNHkinLepTopPt[ich][i][syst] = new TH1D(Form("h_FCNHkinLepTopPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Top p_{T} (Lep)", 30 , 0, 400);
        h_FCNHkinLepTopPt[ich][i][syst]->SetXTitle("Top p_{T} (Lep) (GeV)");
        h_FCNHkinLepTopPt[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinLepTopPt[ich][i][syst]);

        h_FCNHkinHadTopPt[ich][i][syst] = new TH1D(Form("h_FCNHkinHadTopPt_Ch%i_S%i%s",ich,i,syst_name[syst]), "Top p_{T} (Had)", 30 , 0, 400);
        h_FCNHkinHadTopPt[ich][i][syst]->SetXTitle("Top p_{T} (Had) (GeV)");
        h_FCNHkinHadTopPt[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinHadTopPt[ich][i][syst]);

        h_FCNHkinScore[ich][i][syst] = new TH1D(Form("h_FCNHkinScore_Ch%i_S%i%s",ich,i,syst_name[syst]), "DNN Score", 20, 0 ,1);
        h_FCNHkinScore[ich][i][syst]->SetXTitle("DNN Score for Jet Assignment");
        h_FCNHkinScore[ich][i][syst]->Sumw2();
        fOutput->Add(h_FCNHkinScore[ich][i][syst]);

        if( draw_input ){

          h_jet0pt[ich][i][syst] = new TH1D(Form("h_jet0pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet0pt", 20,0,400);
          h_jet0pt[ich][i][syst]->SetXTitle("jet0pt");
          h_jet0pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet0pt[ich][i][syst]);

          h_jet0eta[ich][i][syst] = new TH1D(Form("h_jet0eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet0eta", 20,-2.5,2.5);
          h_jet0eta[ich][i][syst]->SetXTitle("jet0eta");
          h_jet0eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet0eta[ich][i][syst]);

          h_jet0m[ich][i][syst] = new TH1D(Form("h_jet0m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet0m", 20,0,50);
          h_jet0m[ich][i][syst]->SetXTitle("jet0m");
          h_jet0m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet0m[ich][i][syst]);

          h_jet0csv[ich][i][syst] = new TH1D(Form("h_jet0csv_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet0csv", 20,0,1);
          h_jet0csv[ich][i][syst]->SetXTitle("jet0csv");
          h_jet0csv[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet0csv[ich][i][syst]);

          h_jet1pt[ich][i][syst] = new TH1D(Form("h_jet1pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet1pt", 20,0,400);
          h_jet1pt[ich][i][syst]->SetXTitle("jet1pt");
          h_jet1pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet1pt[ich][i][syst]);

          h_jet1eta[ich][i][syst] = new TH1D(Form("h_jet1eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet1eta", 20,-2.5,2.5);
          h_jet1eta[ich][i][syst]->SetXTitle("jet1eta");
          h_jet1eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet1eta[ich][i][syst]);

          h_jet1m[ich][i][syst] = new TH1D(Form("h_jet1m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet1m", 20,0,50);
          h_jet1m[ich][i][syst]->SetXTitle("jet1m");
          h_jet1m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet1m[ich][i][syst]);

          h_jet1csv[ich][i][syst] = new TH1D(Form("h_jet1csv_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet1csv", 20,0,1);
          h_jet1csv[ich][i][syst]->SetXTitle("jet1csv");
          h_jet1csv[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet1csv[ich][i][syst]);

          h_jet2pt[ich][i][syst] = new TH1D(Form("h_jet2pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet2pt", 20,0,400);
          h_jet2pt[ich][i][syst]->SetXTitle("jet2pt");
          h_jet2pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet2pt[ich][i][syst]);
      
          h_jet2eta[ich][i][syst] = new TH1D(Form("h_jet2eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet2eta", 20,-2.5,2.5);
          h_jet2eta[ich][i][syst]->SetXTitle("jet2eta");
          h_jet2eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet2eta[ich][i][syst]);

          h_jet2m[ich][i][syst] = new TH1D(Form("h_jet2m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet2m", 20,0,50);
          h_jet2m[ich][i][syst]->SetXTitle("jet2m");
          h_jet2m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet2m[ich][i][syst]);

          h_jet2csv[ich][i][syst] = new TH1D(Form("h_jet2csv_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet2csv", 20,0,1);
          h_jet2csv[ich][i][syst]->SetXTitle("jet2csv");
          h_jet2csv[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet2csv[ich][i][syst]);

          h_jet3pt[ich][i][syst] = new TH1D(Form("h_jet3pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet3pt", 20,0,400);
          h_jet3pt[ich][i][syst]->SetXTitle("jet3pt");
          h_jet3pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet3pt[ich][i][syst]);

          h_jet3eta[ich][i][syst] = new TH1D(Form("h_jet3eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet3eta", 20,-2.5,2.5);
          h_jet3eta[ich][i][syst]->SetXTitle("jet3eta");
          h_jet3eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet3eta[ich][i][syst]);

          h_jet3m[ich][i][syst] = new TH1D(Form("h_jet3m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet3m", 20,0,50);
          h_jet3m[ich][i][syst]->SetXTitle("jet3m");
          h_jet3m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet3m[ich][i][syst]);

          h_jet3csv[ich][i][syst] = new TH1D(Form("h_jet3csv_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet3csv", 20,0,1);
          h_jet3csv[ich][i][syst]->SetXTitle("jet3csv");
          h_jet3csv[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet3csv[ich][i][syst]);

          h_jet12pt[ich][i][syst] = new TH1D(Form("h_jet12pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12pt", 20,0,400);
          h_jet12pt[ich][i][syst]->SetXTitle("jet12pt");
          h_jet12pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12pt[ich][i][syst]);

          h_jet12eta[ich][i][syst] = new TH1D(Form("h_jet12eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12eta", 20,-3.0,3.0);
          h_jet12eta[ich][i][syst]->SetXTitle("jet12eta");
          h_jet12eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12eta[ich][i][syst]);

          h_jet12deta[ich][i][syst] = new TH1D(Form("h_jet12deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12deta", 20,-3.0,3.0);
          h_jet12deta[ich][i][syst]->SetXTitle("jet12deta");
          h_jet12deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12deta[ich][i][syst]);

          h_jet12dphi[ich][i][syst] = new TH1D(Form("h_jet12dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12dphi", 20,-3.2,3.2);
          h_jet12dphi[ich][i][syst]->SetXTitle("jet12dphi");
          h_jet12dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12dphi[ich][i][syst]);

          h_jet12dR[ich][i][syst] = new TH1D(Form("h_jet12dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12dR", 20,0,4);
          h_jet12dR[ich][i][syst]->SetXTitle("jet12dR");
          h_jet12dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12dR[ich][i][syst]);

          h_jet12m[ich][i][syst] = new TH1D(Form("h_jet12m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12m", 20,50,450);
          h_jet12m[ich][i][syst]->SetXTitle("jet12m");
          h_jet12m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12m[ich][i][syst]);

          h_jet23pt[ich][i][syst] = new TH1D(Form("h_jet23pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23pt", 20,0,400);
          h_jet23pt[ich][i][syst]->SetXTitle("jet23pt");
          h_jet23pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23pt[ich][i][syst]);

          h_jet23eta[ich][i][syst] = new TH1D(Form("h_jet23eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23eta", 20,-3.0,3.0);
          h_jet23eta[ich][i][syst]->SetXTitle("jet23eta");
          h_jet23eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23eta[ich][i][syst]);

          h_jet23deta[ich][i][syst] = new TH1D(Form("h_jet23deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23deta", 20,-3.0,3.0);
          h_jet23deta[ich][i][syst]->SetXTitle("jet23deta");
          h_jet23deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23deta[ich][i][syst]);

          h_jet23dphi[ich][i][syst] = new TH1D(Form("h_jet23dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23dphi", 20,-3.2,3.2);
          h_jet23dphi[ich][i][syst]->SetXTitle("jet23dphi");
          h_jet23dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23dphi[ich][i][syst]);

          h_jet23dR[ich][i][syst] = new TH1D(Form("h_jet23dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23dR", 20,0,4);
          h_jet23dR[ich][i][syst]->SetXTitle("jet23dR");
          h_jet23dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23dR[ich][i][syst]);

          h_jet23m[ich][i][syst] = new TH1D(Form("h_jet23m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23m", 20,50,450);
          h_jet23m[ich][i][syst]->SetXTitle("jet23m");
          h_jet23m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23m[ich][i][syst]);

          h_jet31pt[ich][i][syst] = new TH1D(Form("h_jet31pt_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31pt", 20,0,400);
          h_jet31pt[ich][i][syst]->SetXTitle("jet31pt");
          h_jet31pt[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31pt[ich][i][syst]);
    
          h_jet31eta[ich][i][syst] = new TH1D(Form("h_jet31eta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31eta", 20,-3.0,3.0);
          h_jet31eta[ich][i][syst]->SetXTitle("jet31eta");
          h_jet31eta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31eta[ich][i][syst]);

          h_jet31deta[ich][i][syst] = new TH1D(Form("h_jet31deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31deta", 20,-3.0,3.0);
          h_jet31deta[ich][i][syst]->SetXTitle("jet31deta");
          h_jet31deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31deta[ich][i][syst]);

          h_jet31dphi[ich][i][syst] = new TH1D(Form("h_jet31dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31dphi", 20,-3.2,3.2);
          h_jet31dphi[ich][i][syst]->SetXTitle("jet31dphi");
          h_jet31dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31dphi[ich][i][syst]);

          h_jet31dR[ich][i][syst] = new TH1D(Form("h_jet31dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31dR", 20,0,4);
          h_jet31dR[ich][i][syst]->SetXTitle("jet31dR");
          h_jet31dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31dR[ich][i][syst]);

          h_jet31m[ich][i][syst] = new TH1D(Form("h_jet31m_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31m", 20,50,450);
          h_jet31m[ich][i][syst]->SetXTitle("jet31m");
          h_jet31m[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31m[ich][i][syst]);

          h_lepTpt[ich][i][syst] = new TH1D(Form("h_lepTpt_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTpt", 20,0,400);
          h_lepTpt[ich][i][syst]->SetXTitle("lepTpt");
          h_lepTpt[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTpt[ich][i][syst]);

          h_lepTdphi[ich][i][syst] = new TH1D(Form("h_lepTdphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTdphi", 20,-3.2,3.2);
          h_lepTdphi[ich][i][syst]->SetXTitle("lepTdphi");
          h_lepTdphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTdphi[ich][i][syst]);

          h_lepTm[ich][i][syst] = new TH1D(Form("h_lepTm_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTm", 20,0,450);
          h_lepTm[ich][i][syst]->SetXTitle("lepTm");
          h_lepTm[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTm[ich][i][syst]);

          h_hadTpt[ich][i][syst] = new TH1D(Form("h_hadTpt_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadTpt", 20,0,400);
          h_hadTpt[ich][i][syst]->SetXTitle("hadTpt");
          h_hadTpt[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadTpt[ich][i][syst]);

          h_hadTeta[ich][i][syst] = new TH1D(Form("h_hadTeta_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadTeta", 20,-3.0,3.0);
          h_hadTeta[ich][i][syst]->SetXTitle("hadTeta");
          h_hadTeta[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadTeta[ich][i][syst]);

          h_hadT12_3deta[ich][i][syst] = new TH1D(Form("h_hadT12_3deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT12_3deta", 20,-3.0,3.0);
          h_hadT12_3deta[ich][i][syst]->SetXTitle("hadT12_3deta");
          h_hadT12_3deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT12_3deta[ich][i][syst]);

          h_hadT23_1deta[ich][i][syst] = new TH1D(Form("h_hadT23_1deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT23_1deta", 20,-3.0,3.0);
          h_hadT23_1deta[ich][i][syst]->SetXTitle("hadT23_1deta");
          h_hadT23_1deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT23_1deta[ich][i][syst]);

          h_hadT31_2deta[ich][i][syst] = new TH1D(Form("h_hadT31_2deta_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT31_2deta", 20,-3.0,3.0);
          h_hadT31_2deta[ich][i][syst]->SetXTitle("hadT31_2deta");
          h_hadT31_2deta[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT31_2deta[ich][i][syst]);

          h_hadT12_3dphi[ich][i][syst] = new TH1D(Form("h_hadT12_3dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT12_3dphi", 20,-3.2,3.2);
          h_hadT12_3dphi[ich][i][syst]->SetXTitle("hadT12_3dphi");
          h_hadT12_3dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT12_3dphi[ich][i][syst]);

          h_hadT23_1dphi[ich][i][syst] = new TH1D(Form("h_hadT23_1dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT23_1dphi", 20,-3.2,3.2);
          h_hadT23_1dphi[ich][i][syst]->SetXTitle("hadT23_1dphi");
          h_hadT23_1dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT23_1dphi[ich][i][syst]);

          h_hadT31_2dphi[ich][i][syst] = new TH1D(Form("h_hadT31_2dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT31_2dphi", 20,-3.2,3.2);
          h_hadT31_2dphi[ich][i][syst]->SetXTitle("hadT31_2dphi");
          h_hadT31_2dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT31_2dphi[ich][i][syst]);

          h_hadT12_3dR[ich][i][syst] = new TH1D(Form("h_hadT12_3dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT12_3dR", 20,0,4.0);
          h_hadT12_3dR[ich][i][syst]->SetXTitle("hadT12_3dR");
          h_hadT12_3dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT12_3dR[ich][i][syst]);

          h_hadT23_1dR[ich][i][syst] = new TH1D(Form("h_hadT23_1dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT23_1dR", 20,0,4.0);
          h_hadT23_1dR[ich][i][syst]->SetXTitle("hadT23_1dR");
          h_hadT23_1dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT23_1dR[ich][i][syst]);

          h_hadT31_2dR[ich][i][syst] = new TH1D(Form("h_hadT31_2dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT31_2dR", 20,0,4.0);
          h_hadT31_2dR[ich][i][syst]->SetXTitle("hadT31_2dR");
          h_hadT31_2dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT31_2dR[ich][i][syst]);

          h_hadTm[ich][i][syst] = new TH1D(Form("h_hadTm_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadTm", 20,50,450);
          h_hadTm[ich][i][syst]->SetXTitle("hadTm");
          h_hadTm[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadTm[ich][i][syst]);

          h_jet0lepdR[ich][i][syst] = new TH1D(Form("h_jet0lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet0lepdR", 20,0,4.0);
          h_jet0lepdR[ich][i][syst]->SetXTitle("jet0lepdR");
          h_jet0lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet0lepdR[ich][i][syst]);

          h_jet1lepdR[ich][i][syst] = new TH1D(Form("h_jet1lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet1lepdR", 20,0,4.0);
          h_jet1lepdR[ich][i][syst]->SetXTitle("jet1lepdR");
          h_jet1lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet1lepdR[ich][i][syst]);

          h_jet2lepdR[ich][i][syst] = new TH1D(Form("h_jet2lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet2lepdR", 20,0,4.0);
          h_jet2lepdR[ich][i][syst]->SetXTitle("jet2lepdR");
          h_jet2lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet2lepdR[ich][i][syst]);

          h_jet3lepdR[ich][i][syst] = new TH1D(Form("h_jet3lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet3lepdR", 20,0,4.0);
          h_jet3lepdR[ich][i][syst]->SetXTitle("jet3lepdR");
          h_jet3lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet3lepdR[ich][i][syst]);

          h_jet01dR[ich][i][syst] = new TH1D(Form("h_jet01dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet01dR", 20,0,4.0);
          h_jet01dR[ich][i][syst]->SetXTitle("jet01dR");
          h_jet01dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet01dR[ich][i][syst]);

          h_jet02dR[ich][i][syst] = new TH1D(Form("h_jet02dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet02dR", 20,0,4.0);
          h_jet02dR[ich][i][syst]->SetXTitle("jet02dR");
          h_jet02dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet02dR[ich][i][syst]);

          h_jet03dR[ich][i][syst] = new TH1D(Form("h_jet03dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet03dR", 20,0,4.0);
          h_jet03dR[ich][i][syst]->SetXTitle("jet03dR");
          h_jet03dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet03dR[ich][i][syst]);

          h_jet12_lepdR[ich][i][syst] = new TH1D(Form("h_jet12_lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12_lepdR", 20,0,4.0);
          h_jet12_lepdR[ich][i][syst]->SetXTitle("jet12_lepdR");
          h_jet12_lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12_lepdR[ich][i][syst]);

          h_jet23_lepdR[ich][i][syst] = new TH1D(Form("h_jet23_lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23_lepdR", 20,0,4.0);
          h_jet23_lepdR[ich][i][syst]->SetXTitle("jet23_lepdR");
          h_jet23_lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23_lepdR[ich][i][syst]);

          h_jet31_lepdR[ich][i][syst] = new TH1D(Form("h_jet31_lepdR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31_lepdR", 20,0,4.0);
          h_jet31_lepdR[ich][i][syst]->SetXTitle("jet31_lepdR");
          h_jet31_lepdR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31_lepdR[ich][i][syst]);

          h_jet12_0dR[ich][i][syst] = new TH1D(Form("h_jet12_0dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet12_0dR", 20,0,4.0);
          h_jet12_0dR[ich][i][syst]->SetXTitle("jet12_0dR");
          h_jet12_0dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet12_0dR[ich][i][syst]);

          h_jet23_0dR[ich][i][syst] = new TH1D(Form("h_jet23_0dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet23_0dR", 20,0,4.0);
          h_jet23_0dR[ich][i][syst]->SetXTitle("jet23_0dR");
          h_jet23_0dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet23_0dR[ich][i][syst]);

          h_jet31_0dR[ich][i][syst] = new TH1D(Form("h_jet31_0dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "jet31_0dR", 20,0,4.0);
          h_jet31_0dR[ich][i][syst]->SetXTitle("jet31_0dR");
          h_jet31_0dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_jet31_0dR[ich][i][syst]);

          h_lepTjet12dphi[ich][i][syst] = new TH1D(Form("h_lepTjet12dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTjet12dphi", 20,-3.2,3.2);
          h_lepTjet12dphi[ich][i][syst]->SetXTitle("lepTjet12dphi");
          h_lepTjet12dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTjet12dphi[ich][i][syst]);

          h_lepTjet23dphi[ich][i][syst] = new TH1D(Form("h_lepTjet23dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTjet23dphi", 20,-3.2,3.2);
          h_lepTjet23dphi[ich][i][syst]->SetXTitle("lepTjet23dphi");
          h_lepTjet23dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTjet23dphi[ich][i][syst]);

          h_lepTjet31dphi[ich][i][syst] = new TH1D(Form("h_lepTjet31dphi_Ch%i_S%i%s",ich,i,syst_name[syst]), "lepTjet31dphi", 20,-3.2,3.2);
          h_lepTjet31dphi[ich][i][syst]->SetXTitle("lepTjet31dphi");
          h_lepTjet31dphi[ich][i][syst]->Sumw2();
          fOutput->Add(h_lepTjet31dphi[ich][i][syst]);

          h_hadT_jet0dR[ich][i][syst] = new TH1D(Form("h_hadT_jet0dR_Ch%i_S%i%s",ich,i,syst_name[syst]), "hadT_jet0dR", 20,0,4.0);
          h_hadT_jet0dR[ich][i][syst]->SetXTitle("hadT_jet0dR");
          h_hadT_jet0dR[ich][i][syst]->Sumw2();
          fOutput->Add(h_hadT_jet0dR[ich][i][syst]);
        }//input
      }//syst
    }//step

    for(int ijet=0; ijet<3; ijet++){
      bSFInfo[ich][ijet] = new TH1D(Form("bSFInfo_Ch%i_J%i",ich,ijet), "bSF info for normalization", 18, 0, 18);
      bSFInfo[ich][ijet]->SetXTitle("bSF Sum of weight");
      bSFInfo[ich][ijet]->Sumw2();
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(1,"Raw");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(2,"Nominal");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(3,"lfup");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(4,"lfdown");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(5,"hfup");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(6,"hfdown");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(7,"hfstat1up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(8,"hfstat1down");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(9,"hfstat2up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(10,"hfstat2down");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(11,"lfstat1up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(12,"lfstat1down");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(13,"lfstat2up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(14,"lfstat2down");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(15,"cferr1up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(16,"cferr1down");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(17,"cferr2up");
      bSFInfo[ich][ijet]->GetXaxis()->SetBinLabel(18,"cferr2down");
      fOutput->Add(bSFInfo[ich][ijet]);
    }
  }//ich
} 

Bool_t MyAnalysis::Process(Long64_t entry)
{
  fReader.SetEntry(entry);
  TString option = GetOption();

  bool doQCDEst = false;

  int era = 0;
  TString current_file_name = MyAnalysis::fReader.GetTree()->GetCurrentFile()->GetName();
  if     ( current_file_name.Contains("V9") ) era = 2017;
  else if( current_file_name.Contains("V10") ) era = 2018;
  //cout << era;

  int mode = 999; 
  mode = *channel;
  if( mode > 2 ) return kTRUE;

  float wrongPVrate = 1;
  if( era == 2017 ){
    if( !option.Contains("Run2017") ){
      if     ( option.Contains("DYJets10to50") ) wrongPVrate = 1.02921;
      else if( option.Contains("QCDEM15to20") ) wrongPVrate = 1.01333;
      else if( option.Contains("QCDEM20to30") ) wrongPVrate = 1.01227;
      else if( option.Contains("QCDEM300toInf") ) wrongPVrate = 1.01194;
      else if( option.Contains("QCDEM50to80") ) wrongPVrate = 1.02226;
      else if( option.Contains("QCDMu120to170") ) wrongPVrate = 1.01289;
      else if( option.Contains("QCDMu170to300") ) wrongPVrate = 1.01181;
      else if( option.Contains("QCDMu20to30") ) wrongPVrate = 1.0253;
      else if( option.Contains("QCDMu30to50") ) wrongPVrate = 1.02105;
      else if( option.Contains("QCDMu470to600") ) wrongPVrate = 1.0141;
      else if( option.Contains("QCDMu50to80") ) wrongPVrate = 1.01149;
      else if( option.Contains("QCDMu80to120") ) wrongPVrate = 1.01278;
      else if( option.Contains("TTLLpowhegttbbhdampup") ) wrongPVrate = 1.01807;
      else if( option.Contains("TTLLpowhegttcchdampup") ) wrongPVrate = 1.01978;
      else if( option.Contains("TTLLpowhegttlfhdampup") ) wrongPVrate = 1.01938;
      else if( option.Contains("TTZToLLNuNu") ) wrongPVrate = 1.02425;
      else if( option.Contains("TTpowhegttbbTuneCP5down") ) wrongPVrate = 1.02715;
      else if( option.Contains("TTpowhegttbbhdampdown") ) wrongPVrate = 1.02717;
      else if( option.Contains("TTpowhegttccTuneCP5down") ) wrongPVrate = 1.0273;
      else if( option.Contains("TTpowhegttcchdampdown") ) wrongPVrate = 1.02746;
      else if( option.Contains("TTpowhegttlfTuneCP5down") ) wrongPVrate = 1.02742;
      else if( option.Contains("TTpowhegttlfhdampdown") ) wrongPVrate = 1.02774;
      else if( option.Contains("W3JetsToLNu") ) wrongPVrate = 1.02348;
      else if( option.Contains("WW") ) wrongPVrate = 1.0295;
      else if( option.Contains("WZ") ) wrongPVrate = 1.02298;
      else if( option.Contains("ZZ") ) wrongPVrate = 1.01508;
      else   wrongPVrate = 1.0;
    }
    if( wrongPVrate > 1.01 ){
      if( *TruePV <=0 ) return kTRUE;
    }
  }

  float relIso = *lepton_relIso; 

  //Object selection
  int njets = 0;
  int nbjets_m = 0; 
  int nbjets_t = 0; 
  int ncjets_m = 0; 

  TLorentzVector p4met;
  float met = *MET;
  float met_phi = *MET_phi;
  float apt = TMath::Abs(met);
  float met_x = apt*TMath::Cos(met_phi);
  float met_y = apt*TMath::Sin(met_phi);
  //p4met.SetPxPyPzE( met_x, met_y, 0, met);

  TLorentzVector lepton;
  lepton.SetPtEtaPhiE(*lepton_pt, *lepton_eta, *lepton_phi, *lepton_e);
  //lepton = lepton*lepton_scale[0];

  //for Kin 
  bool match1 = false;
  bool match2 = false;
  float gendR = -1.0;
  float matchdR = -1.0;
  float genHm = 0;
  float matchHm = 0;

  //Event selection 
  bool passmuon = (mode == 0) && (lepton.Pt() > 30) && (abs(lepton.Eta()) <= 2.4);
  bool passelectron = (mode == 1) && (lepton.Pt() > 30) && (abs(lepton.Eta()) <= 2.4);

  //Single Lepton only
  if( option.Contains("SingleMuon") ){
    if( !passmuon ) return kTRUE;//RDMu
    if( passelectron ) return kTRUE;//RDMu
  }
  else if( option.Contains("SingleElectron") ){
    if( !passelectron ) return kTRUE;//RDelec
    if( passmuon ) return kTRUE;//RDelec
  }
  else{
    if( !passmuon && !passelectron ) return kTRUE;
  }
  //if( passmuon || passelectron ){

  //For reco
  int jetIdx[4];
  float recoScore = -1;
  TLorentzVector jetP4s[4];
  //For reco

  float bWP_M, bWP_T, cvsbWP_M, cvslWP_M;
  if( era == 2017 ){
    bWP_M = 0.4941;
    bWP_T = 0.8001;
    cvsbWP_M = 0.28;
    cvslWP_M = 0.15;
  }
  else if( era == 2018 ){
    bWP_M = 0.4184;
    bWP_T = 0.7527;
    //bWP_M = 0.2770; //deepJet
    //bWP_T = 0.7264;
    cvsbWP_M = 0.29;
    cvslWP_M = 0.137;
  }
  else{
    bWP_M = 0.0;
    bWP_T = 0.0;
    cvsbWP_M = 0.0;
    cvslWP_M = 0.0;
  }

  float met_var_x = 0.;
  float met_var_y = 0.;
  vector<size_t> jetIdxs;
  vector<float> jetPts;
  vector<float> jetEtas;

  for (unsigned int iJet = 0; iJet < jet_pt.GetSize() ; ++iJet) {

    TLorentzVector jet;
    jet.SetPtEtaPhiE(jet_pt[iJet], jet_eta[iJet], jet_phi[iJet], jet_e[iJet]);

    float org_px = jet.Px();
    float org_py = jet.Py();

    if( !option.Contains("Run201") ){
      if     ( syst_ext == "jecup" )   jet = jet * jet_JER_Nom[iJet] * jet_JES_Up[iJet];
      else if( syst_ext == "jecdown" ) jet = jet * jet_JER_Nom[iJet] * jet_JES_Down[iJet];
      else if( syst_ext == "jerup" )   jet = jet * jet_JER_Up[iJet];
      else if( syst_ext == "jerdown" ) jet = jet * jet_JER_Down[iJet];
      else                             jet = jet * jet_JER_Nom[iJet];

      //Example of iterator for TTreeReaderArray
      //TTreeReaderArray<vector<float>>::iterator iter;
      //for( iter = jet_JESCom_Up.begin(); iter != jet_JESCom_Up.end(); iter++ ){
      //  cout << iter->at(1) << " ";
      //}
      //Regouped JEC V2, JEC should be applied on top of JER_Nom
      //ORDER DOES MATTER
      if     ( syst_ext == "jecAbsoluteup" )                     jet = jet * (1+jet_JESCom_Up[iJet].at(0));
      else if( syst_ext == "jecAbsolutedown" )                   jet = jet * (1-jet_JESCom_Down[iJet].at(0));
      else if( syst_ext == Form("jecAbsolute%iup",era) )         jet = jet * (1+jet_JESCom_Up[iJet].at(1));
      else if( syst_ext == Form("jecAbsolute%idown",era) )       jet = jet * (1-jet_JESCom_Down[iJet].at(1));
      else if( syst_ext == "jecBBEC1up" )                        jet = jet * (1+jet_JESCom_Up[iJet].at(2));
      else if( syst_ext == "jecBBEC1down" )                      jet = jet * (1-jet_JESCom_Down[iJet].at(2));
      else if( syst_ext == Form("jecBBEC1%iup",era) )            jet = jet * (1+jet_JESCom_Up[iJet].at(3));
      else if( syst_ext == Form("jecBBEC1%idown",era) )          jet = jet * (1-jet_JESCom_Down[iJet].at(3));
      else if( syst_ext == "jecFlavorQCDup" )                    jet = jet * (1+jet_JESCom_Up[iJet].at(4));
      else if( syst_ext == "jecFlavorQCDdown" )                  jet = jet * (1-jet_JESCom_Down[iJet].at(4));
      else if( syst_ext == "jecRelativeBalup" )                  jet = jet * (1+jet_JESCom_Up[iJet].at(5));
      else if( syst_ext == "jecRelativeBaldown" )                jet = jet * (1-jet_JESCom_Down[iJet].at(5));
      else if( syst_ext == Form("jecRelativeSample%iup",era) )   jet = jet * (1+jet_JESCom_Up[iJet].at(6));
      else if( syst_ext == Form("jecRelativeSample%idown",era) ) jet = jet * (1-jet_JESCom_Down[iJet].at(6));

      //MET' = MET + \deltaMET, \deltaMET = MET' - MET
      met_var_x = met_var_x + (jet.Px() - org_px);
      met_var_y = met_var_y + (jet.Py() - org_py);
    }

    if( jet.Pt() > 30 && abs(jet.Eta()) <= 2.4 ){
      njets++;
      jetIdxs.push_back(iJet);
      jetPts.push_back(jet.Pt());
      jetEtas.push_back(jet.Eta());

      if( jet_deepCSV[iJet] > bWP_M ) nbjets_m++;
      //if( jet_deepJet[iJet] > bWP_M ) nbjets_m++;
      if( jet_deepCSV[iJet] > bWP_T ) nbjets_t++;
      if( jet_deepCvsL[iJet] > cvslWP_M && jet_deepCvsB[iJet] > cvsbWP_M ) ncjets_m++;
    }
  }

  if( !option.Contains("Run201") ){
    if( syst_ext == "jecup" ){
      met_x = MET_unc_x[0]; met_y = MET_unc_y[0];
    }
    else if( syst_ext == "jecdown" ){
      met_x = MET_unc_x[1]; met_y = MET_unc_y[1];
    }
    else if( syst_ext == "jerup" ){
      met_x = MET_unc_x[2]; met_y = MET_unc_y[2];
    }
    else if( syst_ext == "jerdown" ){
      met_x = MET_unc_x[3]; met_y = MET_unc_y[3];
    }
    else{
      met_x = met_x - met_var_x;
      met_y = met_y - met_var_y;
    }
  }
  p4met.SetPxPyPzE(met_x, met_y, 0, sqrt(met_x*met_x + met_y*met_y));
  met = p4met.Pt();
  met_phi = p4met.Phi();

  //Selection Option
  float transverseM = transverseMass(lepton, p4met);
  float lepDphi = lepton.DeltaPhi(p4met);
  //bool isQCD = transverseM < 10 && met < 10 && lepDphi < 1;
  //bool makeIso = true;
  //bool isIso = *lepton_isIso;
  //if( makeIso && !isIso ) return kTRUE;
  //if( !makeIso && isIso ) return kTRUE;
  //if( doQCDEst && !isQCD ) return kTRUE;

  //if( doQCDEst && (njets >= 3 || njets == 0) ) return kTRUE;
  //if( doQCDEst && nbjets_m >= 2 ) return kTRUE;

  TLorentzVector hbjet1, hbjet2, genH;
  if( option.Contains("Hct") || option.Contains("Hut") ){
    if(*Hbjet1_pt > 20 && *Hbjet2_pt > 20 && abs(*Hbjet1_eta) < 2.4 && abs(*Hbjet2_eta) < 2.4){
      hbjet1.SetPtEtaPhiE(*Hbjet1_pt, *Hbjet1_eta, *Hbjet1_phi, *Hbjet1_e);
      hbjet2.SetPtEtaPhiE(*Hbjet2_pt, *Hbjet2_eta, *Hbjet2_phi, *Hbjet2_e);

      genH = hbjet1 + hbjet2;
      gendR = hbjet1.DeltaR(hbjet2);
      genHm = genH.M();
    }
  }

  int njet_cut = 0;
  if( doreco ){
    //Jet Assignment
    vector<double>::iterator iter;
    int evtIdx = 0;
    if     ( reco_id == 0 )                 njet_cut = 3;
    else if( reco_id == 1 or reco_id == 2 ) njet_cut = 4;
    //find combination
    if( njet_cut != 0 && njets >= njet_cut && nbjets_m >= 2 && !lepPt.empty() ){
      for( iter = lepPt.begin(); iter != lepPt.end(); iter++ ){
        if( *iter == static_cast<float>(lepton.Pt()) ){
          int tmpIdx = distance(lepPt.begin(), iter);
          if( missET[tmpIdx] == met ) evtIdx = tmpIdx;
          else continue;
        }
      }
      dupCheck.push_back(evtIdx);
      //cout << evtIdx << endl;

      assignT->GetEntry(evtIdx);
      recoScore = assignT->GetLeaf("score")->GetValue(0);
      int i0 = assignT->GetLeaf("idx0")->GetValue(0);
      int i1 = assignT->GetLeaf("idx1")->GetValue(0);
      int i2 = assignT->GetLeaf("idx2")->GetValue(0);
      int i3 = assignT->GetLeaf("idx3")->GetValue(0);
      jetIdx[0] = i0; jetIdx[1] = i1; jetIdx[2] = i2; jetIdx[3] = i3;
      //cout << i0 << endl;

      for( int i=0; i < 4; i++) jetP4s[i].SetPtEtaPhiE(jet_pt[jetIdx[i]], jet_eta[jetIdx[i]], jet_phi[jetIdx[i]], jet_e[jetIdx[i]]);

      if( !option.Contains("Run201") ){
        if     ( syst_ext == "jecup" )   for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] * jet_JER_Nom[jetIdx[i]] * jet_JES_Up[jetIdx[i]];
        else if( syst_ext == "jecdown" ) for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] * jet_JER_Nom[jetIdx[i]] * jet_JES_Down[jetIdx[i]];
        else if( syst_ext == "jerup" )   for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] * jet_JER_Up[jetIdx[i]];
        else if( syst_ext == "jerdown" ) for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] * jet_JER_Down[jetIdx[i]];
        else                             for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] * jet_JER_Nom[jetIdx[i]];

        //Regouped JEC V2, JEC should be applied on top of JER_Nom
        //ORDER DOES MATTER
        if     ( syst_ext == "jecAbsoluteup" )                     for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(0));
        else if( syst_ext == "jecAbsolutedown" )                   for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(0));
        else if( syst_ext == Form("jecAbsolute%iup",era) )         for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(1));
        else if( syst_ext == Form("jecAbsolute%idown",era) )       for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(1));
        else if( syst_ext == "jecBBEC1up" )                        for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(2));
        else if( syst_ext == "jecBBEC1down" )                      for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(2));
        else if( syst_ext == Form("jecBBEC1%iup",era) )            for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(3));
        else if( syst_ext == Form("jecBBEC1%idown",era) )          for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(3));
        else if( syst_ext == "jecFlavorQCDup" )                    for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(4));
        else if( syst_ext == "jecFlavorQCDdown" )                  for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(4));
        else if( syst_ext == "jecRelativeBalup" )                  for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(5));
        else if( syst_ext == "jecRelativeBaldown" )                for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(5));
        else if( syst_ext == Form("jecRelativeSample%iup",era) )   for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1+jet_JESCom_Up[jetIdx[i]].at(6));
        else if( syst_ext == Form("jecRelativeSample%idown",era) ) for(int i=0; i < 4; i++) jetP4s[i] = jetP4s[i] *  (1-jet_JESCom_Down[jetIdx[i]].at(6));
      }

      if( option.Contains("Hct") || option.Contains("Hut") ){
        if(hbjet1.DeltaR(jetP4s[1]) < 0.4 or hbjet1.DeltaR(jetP4s[2]) < 0.4) match1 = true;
        if(hbjet2.DeltaR(jetP4s[1]) < 0.4 or hbjet2.DeltaR(jetP4s[2]) < 0.4) match2 = true;
      }
    }
  }//reco option

  /////Fill histograms
  int Ncuts = 10;
  bool eventSelection[Ncuts];
  for(int bcut=0; bcut < Ncuts; bcut++) eventSelection[bcut] = false;

  eventSelection[0]  = true;
  eventSelection[1]  = ( njets == 3 );
  eventSelection[2]  = ( njets == 3 ) && ( nbjets_m == 2 );
  eventSelection[3]  = ( njets == 3 ) && ( nbjets_m == 3 );
  eventSelection[4]  = ( njets >= 3 ) && ( nbjets_m >= 2 );
  eventSelection[5]  = ( njets >= 4 );
  eventSelection[6]  = ( njets >= 4 ) && ( nbjets_m == 2 ); 
  eventSelection[7]  = ( njets >= 4 ) && ( nbjets_m == 3 );
  eventSelection[8]  = ( njets >= 4 ) && ( nbjets_m == 4 );
  eventSelection[9]  = ( njets >= 4 ) && ( nbjets_m >= 2 ) && ( nbjets_m <= 4 );
  //eventSelection[0]  = ( njets >= 4 ) && ( nbjets_m >= 2 );
  //eventSelection[1]  = ( njets >= 6 ) && ( nbjets_m >= 2 );
  //eventSelection[2]  = ( njets >= 6 ) && ( nbjets_m >= 4 );

  if( reco_id > 0 ) for( int i=0; i <5; i++) eventSelection[i] = false;

  //int modeArray[2] = {mode, 2};
  int modeArray[1] = {mode};

  for( int MODE : modeArray ){
    for( int cut = 0; cut < 10; cut++){
      if( eventSelection[cut] ){

        int jetmode = -1;
        if     ( cut == 0 ) jetmode = 0;
        else if( cut == 1 ) jetmode = 1;
        else if( cut == 5 ) jetmode = 2; 

        for( int syst = 0; syst != syst_num; ++syst ){
          if( syst > 0 and !dosyst ) continue;

          float EventWeight = 1.0;
          //Multiply syst. to event weight
          if( !option.Contains("Run201") ){
            EventWeight *= wrongPVrate;
            EventWeight *= *genweight;
            if( era == 2017 ){
              //PrefireWeight
              if     ( isPartOf("prefireup", std::string(syst_name[syst])) )   EventWeight *= prefireweight[1];
              else if( isPartOf("prefiredown", std::string(syst_name[syst])) ) EventWeight *= prefireweight[2];
              else   EventWeight *= prefireweight[0];
            }
            //if( option.Contains("owheg") ) EventWeight *= *topptweight; //for now, apply only for ttbar
            //PUWeight
            if     ( isPartOf("puup", std::string(syst_name[syst])) )   EventWeight *= PUWeight[1];
            else if( isPartOf("pudown", std::string(syst_name[syst])) ) EventWeight *= PUWeight[2];
            else   EventWeight *= PUWeight[0];
            //leptonSF
            if( passmuon ){
              //mu ID: 0, mu Iso: 1, mu Trg: 2
              //if     ( isPartOf("__muidup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[1];
              //else if( isPartOf("__muiddown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[2];
              //else   EventWeight *= lepton_SF[0];
              //if     ( isPartOf("__muisoup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[4];
              //else if( isPartOf("__muisodown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[5];
              //else   EventWeight *= lepton_SF[3];
              //if     ( isPartOf("__mutrgup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[7];
              //else if( isPartOf("__mutrgdown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[8];
              //else   EventWeight *= lepton_SF[6];
              if     ( isPartOf("__muidup", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[0] + sqrt(pow(lepton_SF[1] - lepton_SF[0], 2) + pow(0.005, 2));
              else if( isPartOf("__muiddown", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[0] - sqrt(pow(lepton_SF[2] - lepton_SF[0], 2) + pow(0.005, 2));
              else   EventWeight *= lepton_SF[0];
              if     ( isPartOf("__muisoup", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[3] + sqrt(pow(lepton_SF[4] - lepton_SF[3], 2) + pow(0.005, 2));
              else if( isPartOf("__muisodown", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[3] - sqrt(pow(lepton_SF[5] - lepton_SF[3], 2) + pow(0.005, 2));
              else   EventWeight *= lepton_SF[3];
              if     ( isPartOf("__mutrgup", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[6] + sqrt(pow(lepton_SF[7] - lepton_SF[6], 2) + pow(0.005, 2));
              else if( isPartOf("__mutrgdown", std::string(syst_name[syst])) )
                     EventWeight *= lepton_SF[6] - sqrt(pow(lepton_SF[8] - lepton_SF[6], 2) + pow(0.005, 2));
              else   EventWeight *= lepton_SF[6];
              if     ( isPartOf("__elidup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__eliddown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__elrecoup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__elrecodown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__elzvtxup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__elzvtxdown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__eltrgup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__eltrgdown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
            }
            else if( passelectron ){
              //elec ID: 0, elec Reco: 1, elec Zvtx: 2, elec trg: 3
              if     ( isPartOf("__muidup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__muiddown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__muisoup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__muisodown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__mutrgup", std::string(syst_name[syst])) )   EventWeight *= 1.0;
              else if( isPartOf("__mutrgdown", std::string(syst_name[syst])) ) EventWeight *= 1.0;
              else   EventWeight *= 1.0;
              if     ( isPartOf("__elidup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[1];
              else if( isPartOf("__eliddown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[2];
              else   EventWeight *= lepton_SF[0];
              if     ( isPartOf("__elrecoup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[4];
              else if( isPartOf("__elrecodown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[5];
              else   EventWeight *= lepton_SF[3];
              if     ( isPartOf("__elzvtxup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[7];
              else if( isPartOf("__elzvtxdown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[8];
              else   EventWeight *= lepton_SF[6];
              if     ( isPartOf("__eltrgup", std::string(syst_name[syst])) )   EventWeight *= lepton_SF[10];
              else if( isPartOf("__eltrgdown", std::string(syst_name[syst])) ) EventWeight *= lepton_SF[11];
              else   EventWeight *= lepton_SF[9];
            }
            //ME&PS
            //[0] = muF up , [1] = muF down, [2] = muR up, [3] = muR up && muF up, [4] = muR down, [5] = muF down && muF down
            if( option.Contains("TTpowheg") or option.Contains("TTLL") or option.Contains("TTHad")
              or option.Contains("STTH") or option.Contains("TTTH") ){
              //Scale weight
              if     ( isPartOf("scale0", std::string(syst_name[syst])) ) EventWeight *= scaleweight[0];
              else if( isPartOf("scale1", std::string(syst_name[syst])) ) EventWeight *= scaleweight[1];
              else if( isPartOf("scale2", std::string(syst_name[syst])) ) EventWeight *= scaleweight[2];
              else if( isPartOf("scale3", std::string(syst_name[syst])) ) EventWeight *= scaleweight[3];
              else if( isPartOf("scale4", std::string(syst_name[syst])) ) EventWeight *= scaleweight[4];
              else if( isPartOf("scale5", std::string(syst_name[syst])) ) EventWeight *= scaleweight[5];
              else   EventWeight *= 1;
              //PS weight
              if     ( isPartOf("ps0", std::string(syst_name[syst])) ) EventWeight *= psweight[0];//isr down
              else if( isPartOf("ps1", std::string(syst_name[syst])) ) EventWeight *= psweight[1];//fsr down
              else if( isPartOf("ps2", std::string(syst_name[syst])) ) EventWeight *= psweight[2];//isr up
              else if( isPartOf("ps3", std::string(syst_name[syst])) ) EventWeight *= psweight[3];//fsr up
              else   EventWeight *= 1;
              //toppt reweight
              float top1weight = 1.0; float top2weight = 1.0;
              if( option.Contains("TTpowheg") or option.Contains("TTLL") or option.Contains("TTHad") ){
                top1weight = topPtNLOtoNNLO( *gentop1_pt );
                top2weight = topPtNLOtoNNLO( *gentop2_pt );
              }
              else if( option.Contains("TTTH") ){
                top1weight = topPtLOtoNLO( *gentop1_pt ) * topPtNLOtoNNLO( *gentop1_pt );
                top2weight = topPtLOtoNLO( *gentop2_pt ) * topPtNLOtoNNLO( *gentop2_pt );
              }
              if     ( top1weight != 1.0 and top2weight != 1.0 ) EventWeight *= sqrt(top1weight * top2weight);
              else if( top1weight == 1.0 or top2weight == 1.0 )  EventWeight *= top1weight * top2weight;
              else                                               EventWeight *= 1.0;
            }
            else EventWeight *= 1;
            //Deep CSV shape
            float bSF = 1.0;
            if     ( isPartOf("lfup",        std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[3];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(2.5, EventWeight*bSF);
            }
            else if( isPartOf("lfdown",      std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[4];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(3.5, EventWeight*bSF);
            }
            else if( isPartOf("hfup",        std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[5];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(4.5, EventWeight*bSF);
            }
            else if( isPartOf("hfdown",      std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[6];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(5.5, EventWeight*bSF);
            }
            else if( isPartOf("hfstat1up",   std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[7];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(6.5, EventWeight*bSF);
            }
            else if( isPartOf("hfstat1down", std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[8];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(7.5, EventWeight*bSF);
            }
            else if( isPartOf("hfstat2up",   std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[9];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(8.5, EventWeight*bSF);
            }
            else if( isPartOf("hfstat2down", std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[10];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(9.5, EventWeight*bSF);
            }
            else if( isPartOf("lfstat1up",   std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[11];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(10.5, EventWeight*bSF);
            }
            else if( isPartOf("lfstat1down", std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[12];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(11.5, EventWeight*bSF);
            }
            else if( isPartOf("lfstat2up",   std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[13];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(12.5, EventWeight*bSF);
            }
            else if( isPartOf("lfstat2down", std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[14];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(13.5, EventWeight*bSF);
            }
            else if( isPartOf("cferr1up",    std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[15];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(14.5, EventWeight*bSF);
            }
            else if( isPartOf("cferr1down",  std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[16];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(15.5, EventWeight*bSF);
            }
            else if( isPartOf("cferr2up",    std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[17];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(16.5, EventWeight*bSF);
            }
            else if( isPartOf("cferr2down",  std::string(syst_name[syst])) ){
              bSF = jet_SF_deepCSV_30[18];
              if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(17.5, EventWeight*bSF);
            }
            else{
              bSF = jet_SF_deepCSV_30[0];
              //bSF = jet_SF_deepJet_30[0];
              if( !isPartOf("__", std::string(syst_name[syst])) ){
                if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(0.5, EventWeight);
                if( jetmode >= 0 ) bSFInfo[MODE][jetmode]->Fill(1.5, EventWeight*bSF);
              }
            }
            EventWeight *= bSF;
          }

          if( reco_id < 1 ){ //Draw control plots only for STFCNC and noReco
            h_PV[MODE][cut][syst]           ->Fill(*GoodPV, EventWeight);
            h_PVnoSF[MODE][cut][syst]       ->Fill(*GoodPV, EventWeight/PUWeight[0]);
            h_EventWeight[MODE][cut][syst]  ->Fill(EventWeight);
            h_NJet[MODE][cut][syst]         ->Fill(njets, EventWeight);
            h_NBJetCSVv2M[MODE][cut][syst]  ->Fill(nbjets_m, EventWeight);
            h_NBJetCSVv2T[MODE][cut][syst]  ->Fill(nbjets_t, EventWeight);
            h_NCJetM[MODE][cut][syst]       ->Fill(ncjets_m, EventWeight);
            h_LepPt[MODE][cut][syst]        ->Fill(lepton.Pt(), EventWeight);
            h_LepPhi[MODE][cut][syst]       ->Fill(lepton.Phi(), EventWeight);
            h_LepEta[MODE][cut][syst]       ->Fill(lepton.Eta(), EventWeight);
            h_MET[MODE][cut][syst]          ->Fill(met, EventWeight);
            h_WMass[MODE][cut][syst]        ->Fill(transverseM, EventWeight);
            h_DPhi[MODE][cut][syst]         ->Fill(abs(lepDphi), EventWeight);
            h_LepIso[MODE][cut][syst]       ->Fill(relIso, EventWeight);
            if( jetIdxs.size() > 0 ){
              h_LeadJetPt[MODE][cut][syst]    ->Fill(jetPts[0], EventWeight);
              h_LeadJetEta[MODE][cut][syst]   ->Fill(jetEtas[0], EventWeight);
            }
            if( jetIdxs.size() > 1 ){
              h_SubleadJetPt[MODE][cut][syst] ->Fill(jetPts[1], EventWeight);
              h_SubleadJetEta[MODE][cut][syst]->Fill(jetEtas[1], EventWeight);
            }
            for( int ii = 0; ii < njets; ii++){
              const size_t ii1 = jetIdxs[ii];
              auto tmp_csv = jet_deepCSV[ii1];
              if( jet_deepCSV[ii1] < 0 ) tmp_csv = 0;
              h_JetCSV[MODE][cut][syst]->Fill(tmp_csv, EventWeight);
              h_JetCSVnoSF[MODE][cut][syst]->Fill(tmp_csv, EventWeight/jet_SF_deepCSV_30[0]);
            }
          }

          if( doreco ){
            if( njets >= njet_cut && nbjets_m >= 2 ){
              for( int i = 0; i < 3; ++i ){
                const size_t j = jetIdx[i];
                auto tmp_csv = jet_deepCSV[j];
                if( jet_deepCSV[j] < 0 ) tmp_csv = 0;
                h_csv[MODE][cut][syst] ->Fill(tmp_csv, EventWeight);
                h_cvsl[MODE][cut][syst]->Fill(tmp_csv, EventWeight);
                h_cvsb[MODE][cut][syst]->Fill(tmp_csv, EventWeight);
              }
              if( jet_deepCSV[jetIdx[1]] < 0 ) jet_deepCSV[jetIdx[1]] = 0;
              if( jet_deepCSV[jetIdx[2]] < 0 ) jet_deepCSV[jetIdx[2]] = 0;
              h_FCNHkinLepWMass[MODE][cut][syst]  ->Fill(transverseM, EventWeight);
              h_FCNHkinLepTopM[MODE][cut][syst]   ->Fill(transverseMass(lepton+jetP4s[0], p4met), EventWeight);
              h_FCNHkinHadWMass[MODE][cut][syst]  ->Fill((jetP4s[1]+jetP4s[2]).M(), EventWeight);//Also j1+j2!!
              h_FCNHkinHMass[MODE][cut][syst]     ->Fill((jetP4s[1]+jetP4s[2]).M(), EventWeight);
              h_FCNHkinDR[MODE][cut][syst]        ->Fill(jetP4s[1].DeltaR(jetP4s[2]), EventWeight);
              h_FCNHkinHadTopM[MODE][cut][syst]   ->Fill((jetP4s[1]+jetP4s[2]+jetP4s[3]).M(), EventWeight);
              h_FCNHkinHPt[MODE][cut][syst]       ->Fill((jetP4s[1]+jetP4s[2]).Pt(), EventWeight);
              h_FCNHkinHdPhi[MODE][cut][syst]     ->Fill(abs(jetP4s[1].DeltaPhi(jetP4s[2])), EventWeight);
              h_FCNHkinHdEta[MODE][cut][syst]     ->Fill(abs((jetP4s[1]-jetP4s[2]).Eta()), EventWeight);
              h_FCNHkinHb1CSV[MODE][cut][syst]    ->Fill(jet_deepCSV[jetIdx[1]], EventWeight);
              h_FCNHkinHb2CSV[MODE][cut][syst]    ->Fill(jet_deepCSV[jetIdx[2]], EventWeight);
              h_FCNHkinHb1CSVfull[MODE][cut][syst]->Fill(jet_deepCSV[jetIdx[1]], EventWeight);
              h_FCNHkinHb2CSVfull[MODE][cut][syst]->Fill(jet_deepCSV[jetIdx[2]], EventWeight);
              h_FCNHkinLepTopPt[MODE][cut][syst]  ->Fill((lepton+p4met+jetP4s[0]).Pt(), EventWeight);
              h_FCNHkinHadTopPt[MODE][cut][syst]  ->Fill((jetP4s[1]+jetP4s[2]+jetP4s[3]).Pt(), EventWeight);
              h_FCNHkinScore[MODE][cut][syst]     ->Fill(recoScore, EventWeight);

              if( draw_input ){
                h_jet0pt[MODE][cut][syst]->Fill(jetP4s[0].Pt(), EventWeight);
                h_jet0eta[MODE][cut][syst]->Fill(jetP4s[0].Eta(), EventWeight);
                h_jet0m[MODE][cut][syst]->Fill(jetP4s[0].M(), EventWeight);
                h_jet0csv[MODE][cut][syst]->Fill(max(0.f, jet_deepCSV[jetIdx[0]]), EventWeight);

                h_jet1pt[MODE][cut][syst]->Fill(jetP4s[1].Pt(), EventWeight);
                h_jet1eta[MODE][cut][syst]->Fill(jetP4s[1].Eta(), EventWeight);
                h_jet1m[MODE][cut][syst]->Fill(jetP4s[1].M(), EventWeight);
                h_jet1csv[MODE][cut][syst]->Fill(max(0.f, jet_deepCSV[jetIdx[1]]), EventWeight);

                h_jet2pt[MODE][cut][syst]->Fill(jetP4s[2].Pt(), EventWeight);
                h_jet2eta[MODE][cut][syst]->Fill(jetP4s[2].Eta(), EventWeight);
                h_jet2m[MODE][cut][syst]->Fill(jetP4s[2].M(), EventWeight);
                h_jet2csv[MODE][cut][syst]->Fill(max(0.f, jet_deepCSV[jetIdx[2]]), EventWeight);

                h_jet3pt[MODE][cut][syst]->Fill(jetP4s[3].Pt(), EventWeight);
                h_jet3eta[MODE][cut][syst]->Fill(jetP4s[3].Eta(), EventWeight);
                h_jet3m[MODE][cut][syst]->Fill(jetP4s[3].M(), EventWeight);
                h_jet3csv[MODE][cut][syst]->Fill(max(0.f, jet_deepCSV[jetIdx[3]]), EventWeight);

                const auto lepW = lepton + p4met;
                const auto lepT = lepW + jetP4s[0];
                const auto had12 = jetP4s[1] + jetP4s[2];//This is W or H
                const auto had23 = jetP4s[2] + jetP4s[3];
                const auto had31 = jetP4s[3] + jetP4s[1];
                const auto hadT = jetP4s[1] + jetP4s[2] + jetP4s[3];

                h_jet12pt[MODE][cut][syst]->Fill(had12.Pt(), EventWeight);
                h_jet12eta[MODE][cut][syst]->Fill(had12.Eta(), EventWeight);
                h_jet12m[MODE][cut][syst]->Fill(had12.M(), EventWeight);
                h_jet12deta[MODE][cut][syst]->Fill((jetP4s[1]-jetP4s[2]).Eta(), EventWeight);
                h_jet12dphi[MODE][cut][syst]->Fill(jetP4s[1].DeltaPhi(jetP4s[2]), EventWeight);
                h_jet12dR[MODE][cut][syst]->Fill(jetP4s[1].DeltaR(jetP4s[2]), EventWeight);

                h_jet23pt[MODE][cut][syst]->Fill(had23.Pt(), EventWeight);
                h_jet23eta[MODE][cut][syst]->Fill(had23.Eta(), EventWeight);
                h_jet23m[MODE][cut][syst]->Fill(had23.M(), EventWeight);
                h_jet23deta[MODE][cut][syst]->Fill((jetP4s[2]-jetP4s[3]).Eta(), EventWeight);
                h_jet23dphi[MODE][cut][syst]->Fill(jetP4s[2].DeltaPhi(jetP4s[3]), EventWeight);
                h_jet23dR[MODE][cut][syst]->Fill(jetP4s[2].DeltaR(jetP4s[3]), EventWeight);

                h_jet31pt[MODE][cut][syst]->Fill(had31.Pt(), EventWeight);
                h_jet31eta[MODE][cut][syst]->Fill(had31.Eta(), EventWeight);
                h_jet31m[MODE][cut][syst]->Fill(had31.M(), EventWeight);
                h_jet31deta[MODE][cut][syst]->Fill((jetP4s[3]-jetP4s[1]).Eta(), EventWeight);
                h_jet31dphi[MODE][cut][syst]->Fill(jetP4s[3].DeltaPhi(jetP4s[1]), EventWeight);
                h_jet31dR[MODE][cut][syst]->Fill(jetP4s[3].DeltaR(jetP4s[1]), EventWeight);

                h_lepTpt[MODE][cut][syst]->Fill(lepT.Pt(), EventWeight);
                h_lepTdphi[MODE][cut][syst]->Fill(lepW.DeltaPhi(jetP4s[0]), EventWeight);
                h_lepTm[MODE][cut][syst]->Fill(transverseMass(lepton+jetP4s[0],p4met), EventWeight);

                h_hadTpt[MODE][cut][syst]->Fill(hadT.Pt(), EventWeight);
                h_hadTeta[MODE][cut][syst]->Fill(hadT.Eta(), EventWeight);
                h_hadTm[MODE][cut][syst]->Fill(hadT.M(), EventWeight);

                h_hadT12_3deta[MODE][cut][syst]->Fill((had12-jetP4s[3]).Eta(), EventWeight);
                h_hadT23_1deta[MODE][cut][syst]->Fill((had23-jetP4s[1]).Eta(), EventWeight);
                h_hadT31_2deta[MODE][cut][syst]->Fill((had31-jetP4s[2]).Eta(), EventWeight);
                h_hadT12_3dphi[MODE][cut][syst]->Fill(had12.DeltaPhi(jetP4s[3]), EventWeight);
                h_hadT23_1dphi[MODE][cut][syst]->Fill(had23.DeltaPhi(jetP4s[1]), EventWeight);
                h_hadT31_2dphi[MODE][cut][syst]->Fill(had31.DeltaPhi(jetP4s[2]), EventWeight);
                h_hadT12_3dR[MODE][cut][syst]->Fill(had12.DeltaR(jetP4s[3]), EventWeight);
                h_hadT23_1dR[MODE][cut][syst]->Fill(had23.DeltaR(jetP4s[1]), EventWeight);
                h_hadT31_2dR[MODE][cut][syst]->Fill(had31.DeltaR(jetP4s[2]), EventWeight);

                h_jet0lepdR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(lepton), EventWeight);
                h_jet1lepdR[MODE][cut][syst]->Fill(jetP4s[1].DeltaR(lepton), EventWeight);
                h_jet2lepdR[MODE][cut][syst]->Fill(jetP4s[2].DeltaR(lepton), EventWeight);
                h_jet3lepdR[MODE][cut][syst]->Fill(jetP4s[3].DeltaR(lepton), EventWeight);
                h_jet01dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(jetP4s[1]), EventWeight);
                h_jet02dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(jetP4s[2]), EventWeight);
                h_jet03dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(jetP4s[3]), EventWeight);
                h_jet12_lepdR[MODE][cut][syst]->Fill(lepton.DeltaR(had12), EventWeight);
                h_jet23_lepdR[MODE][cut][syst]->Fill(lepton.DeltaR(had23), EventWeight);
                h_jet31_lepdR[MODE][cut][syst]->Fill(lepton.DeltaR(had31), EventWeight);
                h_jet12_0dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(had12), EventWeight);
                h_jet23_0dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(had23), EventWeight);
                h_jet31_0dR[MODE][cut][syst]->Fill(jetP4s[0].DeltaR(had31), EventWeight);
                h_lepTjet12dphi[MODE][cut][syst]->Fill(lepT.DeltaPhi(had12), EventWeight);
                h_lepTjet23dphi[MODE][cut][syst]->Fill(lepT.DeltaPhi(had23), EventWeight);
                h_lepTjet31dphi[MODE][cut][syst]->Fill(lepT.DeltaPhi(had31), EventWeight);
                h_hadT_jet0dR[MODE][cut][syst]->Fill(hadT.DeltaR(jetP4s[0]), EventWeight);
              }//input
            }//njet cut
          }//reco
        }//syst loop
      }//selection loopa
    }//mode loop : e or mu + emu
  }
  evtNum++;
  //cout << evtNum << '\r';

  return kTRUE;
}

void MyAnalysis::SlaveTerminate()
{
  TString option = GetOption();
}
   

void MyAnalysis::Terminate()
{
  TString option = GetOption();
  string sample = option.Data();

  if( option.Contains("_") ){
    doreco = true;
    dosyst = true;
  }
  else{//for no reco
    doreco = false;
    dosyst = false;
  }

  if( option.Contains("Run201") ) dosyst = false;

  const char* assign_file = "";
  if( doreco ){
    string reco_era =  sample.substr(sample.find_first_of("-")+1,4);
    string reco_scheme = sample.substr(sample.find_first_of("-")+5,string::npos);
    syst_ext = "";

    int era = stoi(reco_era);
    if( reco_scheme.find("jec") != string::npos or reco_scheme.find("jer") != string::npos
      or reco_scheme.find("TuneCP5") != string::npos or reco_scheme.find("hdamp") != string::npos ){
      if     ( reco_scheme.find("jecup") != string::npos )       syst_ext = "__jecup";
      else if( reco_scheme.find("jecdown") != string::npos )     syst_ext = "__jecdown";
      else if( reco_scheme.find("jerup") != string::npos )       syst_ext = "__jerup";
      else if( reco_scheme.find("jerdown") != string::npos )     syst_ext = "__jerdown";
      else if( reco_scheme.find("TuneCP5up") != string::npos )   syst_ext = "__TuneCP5up";
      else if( reco_scheme.find("TuneCP5down") != string::npos ) syst_ext = "__TuneCP5down";
      else if( reco_scheme.find("hdampup") != string::npos )     syst_ext = "__hdampup";
      else if( reco_scheme.find("hdampdown") != string::npos )   syst_ext = "__hdampdown";
      //Regrouped JEC V2
      else if( reco_scheme.find("jecAbsoluteup") != string::npos )                     syst_ext = "__jecAbsoluteup";
      else if( reco_scheme.find("jecAbsolutedown") != string::npos )                   syst_ext = "__jecAbsolutedown";
      else if( reco_scheme.find(Form("jecAbsolute%iup",era)) != string::npos )         syst_ext = Form("__jecAbsolute%iup",era);
      else if( reco_scheme.find(Form("jecAbsolute%idown",era)) != string::npos )       syst_ext = Form("__jecAbsolute%idown",era);
      else if( reco_scheme.find("jecBBEC1up") != string::npos )                        syst_ext = "__jecBBEC1up";
      else if( reco_scheme.find("jecBBEC1down") != string::npos )                      syst_ext = "__jecBBEC1down";
      else if( reco_scheme.find(Form("jecBBEC1%iup",era)) != string::npos )            syst_ext = Form("__jecBBEC1%iup",era);
      else if( reco_scheme.find(Form("jecBBEC1%idown",era)) != string::npos )          syst_ext = Form("__jecBBEC1%idown",era);
      else if( reco_scheme.find("jecFlavorQCDup") != string::npos )                    syst_ext = "__jecFlavorQCDup";
      else if( reco_scheme.find("jecFlavorQCDdown") != string::npos )                  syst_ext = "__jecFlavorQCDdown";
      else if( reco_scheme.find("jecRelativeBalup") != string::npos )                  syst_ext = "__jecRelativeBalup";
      else if( reco_scheme.find("jecRelativeBaldown") != string::npos )                syst_ext = "__jecRelativeBaldown";
      else if( reco_scheme.find(Form("jecRelativeSample%iup",era)) != string::npos )   syst_ext = Form("__jecRelativeSample%iup",era);
      else if( reco_scheme.find(Form("jecRelativeSample%idown",era)) != string::npos ) syst_ext = Form("__jecRelativeSample%idown",era);
    }
    sample.erase( sample.find_first_of("-"),string::npos );
    assign_file = Form("./../reco/%s/assign%s/assign_deepReco_%s.root", reco_era.c_str(), reco_scheme.c_str(), sample.c_str());
    string file_tmp_path = assign_file;
    ifstream file_tmp(file_tmp_path);

    if(file_tmp.is_open()){
      //cout << lepcount << endl;
      auto it = unique( dupCheck.begin(), dupCheck.end() );
      if( it != dupCheck.end() ) cout << string(option.Data()) + string(": Duplicate(s)") << endl;
    }
    else cout << "file " + file_tmp_path + " not opened!" << endl;
    //out = TFile::Open(Form("doReco/temp/hist_%s%s.root", sample.c_str(), syst_ext.c_str()),"RECREATE");
    out = TFile::Open(Form("/data1/users/minerva1993/work/fcnc_RunII%i/fullAna/current_ver/temp/hist_%s%s.root", era, sample.c_str(), syst_ext.c_str()),"RECREATE");
  }
  else out = TFile::Open(Form("doNoReco/hist_%s.root", option.Data()),"RECREATE");

  TList * l = GetOutputList();
  TIter next(l);
  TObject *object = 0;
  while( ( object = next()) ){
    const char * name = object->GetName();
    std::string str(name);

    if(str.find("Ch2") != std::string::npos ){
      std::string strMuon = boost::replace_all_copy(str, "Ch2", "Ch0");
      std::string strElec = boost::replace_all_copy(str, "Ch2", "Ch1");
      TList *tmp = new TList;
      if( object->InheritsFrom(TH1D::Class()) ){
        auto htmp = dynamic_cast<TH1D *>(object);
        tmp->Add((TH1D *)fOutput->FindObject(strMuon.c_str()));
        tmp->Add((TH1D *)fOutput->FindObject(strElec.c_str()));
        htmp->Merge(tmp);
      }
    }

    if (str.find("h_") !=std::string::npos or str.find("Info") !=std::string::npos){
      object->Write();
    }
  }

  out->Write();
  out->Close();
}

float MyAnalysis::transverseMass( const TLorentzVector & lepton, const TLorentzVector & met){

  TLorentzVector leptonT(lepton.Px(),lepton.Py(),0.,lepton.E()*TMath::Sin(lepton.Theta()));
  TLorentzVector metT(met.Px(), met.Py(), 0, met.E());

  TLorentzVector sumT=leptonT+metT;
  float out = sumT.M();

  return out;

}

bool MyAnalysis::isPartOf(const std::string& word, const std::string& sentence) {
    return sentence.find(word)    // this returns the index of the first instance
                                  // word
           != std::string::npos;  // which will take this value if it's not found
}

float MyAnalysis::topPtLOtoNLO( float toppt ){

  float weight = 1.0;

  if     ( toppt <= 0 )                     weight = 1.0;
  else if( toppt > 0 and toppt < 50 )       weight = ( 1.748647 + 1.752149 + 1.747765 + 1.748996 ) / 4.0;
  else if( toppt >= 50 and toppt < 100 )    weight = ( 1.759757 + 1.754686 + 1.754359 + 1.753767 ) / 4.0;
  else if( toppt >= 100 and toppt < 150 )   weight = ( 1.710515 + 1.714042 + 1.70896  + 1.707913 ) / 4.0;
  else if( toppt >= 150 and toppt < 200 )   weight = ( 1.634742 + 1.635692 + 1.637983 + 1.639704 ) / 4.0;
  else if( toppt >= 200 and toppt < 250 )   weight = ( 1.539141 + 1.541837 + 1.547243 + 1.544309 ) / 4.0;
  else if( toppt >= 250 and toppt < 300 )   weight = ( 1.454174 + 1.449138 + 1.453648 + 1.4566   ) / 4.0;
  else if( toppt >= 300 and toppt < 350 )   weight = ( 1.376844 + 1.360644 + 1.386458 + 1.367805 ) / 4.0;
  else if( toppt >= 350 and toppt < 400 )   weight = ( 1.307372 + 1.312938 + 1.305165 + 1.320008 ) / 4.0;
  else if( toppt >= 400 and toppt < 450 )   weight = ( 1.197963 + 1.227374 + 1.255603 + 1.270746 ) / 4.0;
  else if( toppt >= 450 and toppt < 500 )   weight = ( 1.19234  + 1.179497 + 1.178465 + 1.209439 ) / 4.0;
  else if( toppt >= 500 and toppt < 550 )   weight = ( 1.139534 + 1.172257 + 1.160954 + 1.210782 ) / 4.0;
  else if( toppt >= 550 and toppt < 600 )   weight = ( 1.135917 + 1.141849 + 1.205256 + 1.195735 ) / 4.0;
  else if( toppt >= 600 and toppt < 800 )   weight = ( 1.089117 + 1.072375 + 1.18809  + 1.11811  ) / 4.0;
  else if( toppt >= 800 and toppt < 1000 )  weight = ( 1.10766  + 1.115636 + 1.170683 + 1.091182 ) / 4.0;
  else if( toppt >= 1000 and toppt < 2000 ) weight = ( 1.07664  + 1.152181 + 1.035299 + 1.203024 ) / 4.0;

  return weight;

}

float MyAnalysis::topPtNLOtoNNLO( float toppt ){

  float weight = 1.0;

  if( toppt > 0. )
    weight = 0.103 * TMath::Exp(-0.0118 * toppt) - 0.000134 * toppt + 0.973;

  return weight;
}
